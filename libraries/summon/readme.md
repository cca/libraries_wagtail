# Summon Deletes

When a record is deleted from our local catalog (Koha), we must update the Summon discovery layer index or else the item will continue to appear in search results.

## Setup

This task depends on the `paramiko` SSH/SFTP library. There is a `SummonDelete` model that represents previous runs of the task; a `SummonDelete` includes the date of the run, the number of deleted records, and a list of deleted record ids. We connect this app to [a public Koha JSON report](https://library-staff.cca.edu/cgi-bin/koha/reports/guided_reports.pl?reports=152&phase=Edit%20SQL) which returns the identifiers (biblionumbers) of deleted records and nothing else. Set this to `SUMMON_REPORT_URL` (e.g. https://library.cca.edu/cgi-bin/koha/svc/report?id=152&sql_params={}). The `SUMMON_SFTP_HOST` and `SUMMON_SFTP_UN` are also in our base settings.

This app is the sole reason for two files under kubernetes/assets. We authenticate using a private key generated by Summon's support team, "cdi_cca.key" (not tracked in version control, available in Dashlane). By default, paramiko checks /root/.ssh/known_hosts and will not connect to a server if it is not listed there, so we include a known_hosts file.

The command _will_ stop working if Summon changes the address of their SFTP server. We can update known_hosts by connecting to the Summon SFTP server (e.g. `sftp -P 10022 -i kubernetes/local/assets/cdi_cca.key 'cdi_cca-catalog@customers.na'@cdi-providers-dc01.hosted.exlibrisgroup.com`) and copying the appended line from our local ~/.ssh/known_hosts file. We could also `ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())` to ignore the host key check, but that is insecure. The `known_hosts` datum in the `summon-sftp-secrets` secret populates the known_hosts file in the container and must be updated:

```fish
# fish shell where NS is k8s namespace
set DATA (cat kubernetes/assets/known_hosts | base64 -w 0)
kubectl -n$NS patch secret summon-sftp-secrets -p "{\"data\":{\"known_hosts\": \"$DATA\"}}"
```

The first time the task runs, there are no previous iterations, which can cause an error. The management command accepts a "date last run" argument so you can run `python manage.py summon_deletes "MM/DD/YYYY"` the first time. Note that **Koha has changed the date format for report parameters _multiple times_** so we may need to try a few different formats and edit the command if they change it again.

After the initial run, the task can be added as a cron job and run regularly.
