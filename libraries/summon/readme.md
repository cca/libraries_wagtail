# Summon Deletes

When a record is deleted from our local catalog (Koha), we must update the Summon discovery layer index or else the item will continue to appear in search results.

## Setup

This task depends on `pysftp` and is the sole reason for that dependency. There is a `SummonDelete` model under this app that represents previous runs of the task; a `SummonDelete` includes the date of the run, the number of deleted records, and a text list of deleted records. We hook this app up to [a public Koha JSON report](https://library-staff.cca.edu/cgi-bin/koha/reports/guided_reports.pl?reports=152&phase=Edit%20SQL) which simply returns the identifiers (biblionumbers) of deleted records and nothing else. Set this to `SUMMON_REPORT_URL`. Example: https://library.cca.edu/cgi-bin/koha/svc/report?id=152&sql_params={} The `SUMMON_SFTP_HOST` and `SUMMON_SFTP_UN` are also in our base settings.

This app is also the sole reason for two files under kubernetes/assets. We authenticate using a private key generated by Summon's support team, "cdi_cca.key". By default, pysftp checks /root/.ssh/known_hosts and it will not connect to a server if it is not listed there. To work around this, we include our own known_hosts file. The command _will_ stop working if Summon changes the address of their SFTP server. We can update known_hosts by connecting to the Summon SFTP server (e.g. `sftp -P 10022 -i path/to/cdi_cca.key 'cdi_cca-catalog@customers.na.txt'@$SUMMON_SFTP_HOST`) and copying the appended line out of our local ~/.ssh/known_hosts file.

The first time the task runs, there are no previous iterations, which can cause an error. The management command accepts a "date last run" argument so you can run `python manage.py summon_deletes "MM/DD/YYYY"` the first time. Note that **Koha has changed the date format for report parameters _multiple times_** so we may need to try a few different formats and edit the command if they change it again.

After the initial run, the task can be added as a cron job and run regularly.

## Custom JavaScript

Summon lets you load a custom JavaScript file under the setting "[Summon 2.0 External Script](https://customize.summon.serialssolutions.com/settings#Summon20ExternalScript)". Our JS does a few things:

- provide our "broken link" reporting (mostly copied from Fairfield U's code)
- insert a custom CSS file (which Summon doesn't provide an option for)
- initialize Google Tag Manager (we are using Tabatha Farney's [GTM configuration for Summon](https://github.com/tabathafarney/GoogleTagManager-Summon))

The JavaScript and SCSS source files are under libraries/libraries/static/summon and have their own gulp build tasks summonCSS, summonJS, and summon (for both).

The easiest way to test is to use [our Summon preview environment](https://cca.preview.summon.serialssolutions.com) if it's available; edit here, push changes to a staging site, swap in the staging site URL in the [preview site's settings](https://customize.preview.summon.serialssolutions.com/settings#Summon20ExternalScript). Since the preview site is not always available, we may need to do this swap on the live Summon instance sometimes.
